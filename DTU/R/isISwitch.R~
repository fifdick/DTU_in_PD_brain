isISwitch <- function(df,gene)
{
	control_biotype=""
	case_biotype=""	
	test <- df %>% dplyr::group_by(gene_id,transcript_id,condition) %>% dplyr::distinct(transcript_id,.keep_all=T)
	test <- test %>% dplyr::group_by(condition) %>% dplyr::summarize(sumNomSig=sum(nomSig))
	#if there are at least two nominally significant transcript in this gene, and both conditions have the same number of nom sig transcripts (is this necessary?!)
	if((test[1,2]==test[2,2]) && (test[1,2] >= 2))
		{      
			isoformSwitch=FALSE 
			# -->commented following line to see what changes 
			#	df <- dplyr::filter(df,nomSig==1)
 			df<-df %>% dplyr::group_by(condition,transcript_id) %>% mutate(median=median.default(frac))
			# interested in ties aswell
			# distinct to select on random sample row representing the transcript. The median in this transcript and condition group will be the same in all sample rows
			#group by condition (again) and run ranks on it. Return all entries with max rank (can be more than one)
			df <- df %>% dplyr::distinct(transcript_id,.keep_all=T) %>% dplyr::group_by(condition) %>% dplyr::slice(which(rank(median,ties.method="min")==max(rank(
			median,ties.method="min"))))
			#add requirement that at least one transcript in each condition that was assigned max rank has to be nomSig==1 could be higher than 1 if there are ties
			mainExprSig=df %>% dplyr::group_by(condition) %>% dplyr::summarize(sumNomSig=sum(nomSig))
			if(subset(mainExprSig,condition==0)$sumNomSig>=1 && subset(mainExprSig,condition==1)$sumNomSig>=1)
			{
				if(nrow(df)>2 && nrow(df)%%2!=0)
				{		
					print(paste0("In Gene ",gene," in one of the conditions, there is more than one dominant transcript"))
					print(df)
				}	else if (nrow(df)>2 && nrow(df)%%2==0){

					print(paste0("In Gene ",gene,", both conditions show more than one dominant transcript"))
					print(df)
				} else if(nrow(df)==1)	
				{print(paste0("In Gene ",gene, ": for one of the conditions the dominant transcript cant be determined"))
					print(df)
				} else if(nrow(df)==0)
				{
					print(paste0("In Gene ",gene," in neither condition a dominant transcript was determined"))
					print(df)
				} else if(nrow(df)==2)
				{
					if(df[1,"transcript_id"]==df[2,"transcript_id"])
					{	
						isoformSwitch=FALSE
						print(paste0("Both conditions share the same dominant transcript - NO isoform switch detected!"))
					}
					else
					{
						print(df)			
						isoformSwitch=TRUE
						print(paste0("Conditions show different dominant transcripts - isoform switch detected!"))
						control_biotype=gsub(".*\n","",dplyr::filter(df,condition==0)$tx_id_label)
						case_biotype=gsub(".*\n","",dplyr::filter(df,condition==1)$tx_id_label) 
						print(paste0("Cases switch from the ",control_biotype," to the ",case_biotype," transcript"))
 						print(df[,c(1,2,6,7,8,12)])	
					}
				}
			}	
			else
			{
				print(paste0("Gene ",gene," doesnt show the main expressed transcript in the DTU event"))
			}
		}
	else 
	{
		print(paste0("Gene ",gene," doesnt have at least 2 nominally significant transcripts"))
		isoformSwitch=FALSE
	}
return(list(isIS=isoformSwitch,CT=control_biotype,CS=case_biotype))
}

